<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«¶åƒ¹ç³»çµ± - ç”¨æˆ¶ç«¯</title>
<style>
/* --- å…¨å±€è®Šæ•¸è¨­å®š (ç¶­æŒåŸæ¨£) --- */
:root {
  --primary: #2563eb;       
  --primary-hover: #1d4ed8;
  --bg: #f8fafc;            
  --card-bg: #ffffff;       
  --text-main: #0f172a;     
  --text-muted: #64748b;    
  --border: #e2e8f0;        
  --danger: #ef4444;        
  --success: #10b981;       
  --accent: #f1f5f9;        
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 12px;           
}

* { box-sizing: border-box; }

body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 40px 20px;
  color: var(--text-main);
  line-height: 1.5;
}

/* --- å·¦å´å´é‚Šæ¬„ --- */
.user-sidebar {
  position: fixed;
  top: 40px; left: 20px; width: 240px;
  background: var(--card-bg); padding: 24px;
  border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border);
  z-index: 100; display: flex; flex-direction: column; gap: 20px;
}
.user-sidebar .sidebar-row { display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
.user-sidebar .sidebar-row:last-of-type { border-bottom: none; }
.user-sidebar .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 700; }
.user-sidebar .value { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }
.user-sidebar .value.wins { color: #d97706; display: flex; align-items: center; gap: 8px; }
.logout-btn { margin-top: auto; width: 100%; padding: 12px; background: white; color: var(--danger); border: 1px solid var(--danger); border-radius: 8px; font-size: 0.95rem; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
.logout-btn:hover { background: var(--danger); color: white; }

/* --- ä¸»é é¢å®¹å™¨ --- */
.page { max-width: 1100px; margin: 0 auto; margin-left: 280px; margin-right: auto; }

/* --- å•†å“è³‡è¨Šå„€è¡¨æ¿ --- */
.product-dashboard { background: var(--card-bg); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border); }
.product-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
.product-header h2 { margin: 0; font-size: 1.5rem; color: var(--primary); }
.refresh-btn { background: var(--accent); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; }
.refresh-btn:hover { background: var(--border); color: var(--text-main); }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
.stat-box { background: var(--bg); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid transparent; }
.stat-box .label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
.stat-box .val { font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
.stat-box.highlight { background: #eff6ff; border-color: #dbeafe; }
.stat-box.highlight .val { color: var(--primary); }
.stat-box.timer .val { color: var(--danger); font-family: monospace; letter-spacing: 1px; }

/* --- ä¸»å…§å®¹å€ --- */
.main-content { display: flex; gap: 24px; align-items: flex-start; }
.bid-section { flex: 0 0 340px; background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); }
.bid-section h1 { margin: 0 0 20px 0; font-size: 1.25rem; color: var(--text-main); }
.input-group { margin-bottom: 20px; }
.input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); }
.input-group input { width: 100%; padding: 12px 16px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 8px; transition: border-color 0.2s; background: var(--bg); }
.input-group input:focus { outline: none; border-color: var(--primary); background: white; }
.action-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); transition: transform 0.1s, background 0.2s; }
.action-btn:hover { background: var(--primary-hover); }
.action-btn:active { transform: translateY(1px); }
#send_output { margin-top: 16px; padding: 12px; border-radius: 8px; background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; font-size: 0.9rem; min-height: 48px; display: flex; align-items: center; justify-content: center; text-align: center; }
.my-status-area { margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
.my-status-area h3 { margin: 0 0 8px 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
#myinfo { font-size: 0.95rem; color: #334155; white-space: pre-wrap; line-height: 1.6; }

/* å³æ¬„ï¼šæ’è¡Œæ¦œ */
.ranking-section { flex: 1; background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); }
.ranking-section h2 { margin: 0 0 15px 0; font-size: 1.25rem; color: var(--text-main); }
.ranking-header { display: grid; grid-template-columns: 60px 1fr 100px 80px 100px; padding: 12px 16px; background: #f1f5f9; border-radius: 8px; font-weight: 700; color: #64748b; font-size: 0.9rem; margin-bottom: 12px; }
.ranking-list { max-height: 450px; overflow-y: auto; }
.rank-row { display: grid; grid-template-columns: 60px 1fr 100px 80px 100px; padding: 12px 16px; border-bottom: 1px solid var(--border); align-items: center; font-size: 0.95rem; transition: background 0.1s; }
.rank-row:hover { background: #f8fafc; }
.rank-row:last-child { border-bottom: none; }
.rank-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; background: #e2e8f0; color: #64748b; }
.rank-row:nth-child(1) .rank-badge { background: #ffd700; color: #fff; }
.rank-row:nth-child(2) .rank-badge { background: #c0c0c0; color: #fff; }
.rank-row:nth-child(3) .rank-badge { background: #cd7f32; color: #fff; }
.rank-user { font-weight: 600; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rank-price { font-weight: 700; color: var(--primary); }
.rank-score { font-weight: 700; color: #d97706; }
.rank-time { font-size: 0.85rem; color: #94a3b8; }
.refresh-rank-btn { width: 100%; margin-top: 15px; padding: 12px; background: var(--bg); border: none; border-radius: 8px; color: var(--text-muted); cursor: pointer; font-weight: 600; transition: background 0.2s; }
.refresh-rank-btn:hover { background: #e2e8f0; color: var(--text-main); }

/* RWD */
@media (max-width: 1100px) {
  .user-sidebar { position: static; width: 100%; margin-bottom: 24px; flex-direction: row; justify-content: space-between; align-items: center; padding: 16px 24px; }
  .user-sidebar .sidebar-row { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
  .logout-btn { width: auto; margin-top: 0; padding: 8px 24px; }
  .page { margin-left: auto; margin-right: auto; }
}
@media (max-width: 900px) {
  .main-content { flex-direction: column-reverse; }
  .bid-section, .ranking-section { width: 100%; flex: auto; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>

<body>

<div class="user-sidebar">
  <div class="sidebar-row">
    <div class="label">User ID</div>
    <div class="value" id="disp-username">--</div>
  </div>
  <div class="sidebar-row">
    <div class="label">Total Wins</div>
    <div class="value wins">
      <span>ğŸ†</span>
      <span id="disp-wins">0</span>
    </div>
  </div>
  <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>
</div>

<div class="page">
  <div class="product-dashboard" id="product-info">
    <div class="product-header">
      <h2 id="product-name">è¼‰å…¥ä¸­...</h2>
      <button class="refresh-btn" onclick="loadProductInfo()">â†» åˆ·æ–°è³‡è¨Š</button>
    </div>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="label">åº«å­˜æ•¸é‡</div>
        <div class="val" id="product-quantity">-</div>
      </div>
      <div class="stat-box highlight">
        <div class="label">ç›®å‰æœ€é«˜åƒ¹</div>
        <div class="val" id="product-highest">-</div>
      </div>
      <div class="stat-box">
        <div class="label">å¾—æ¨™é ä¼°åƒ¹</div>
        <div class="val" id="product-min-score-price">-</div>
      </div>
      <div class="stat-box">
        <div class="label">æœ€ä½åº•åƒ¹</div>
        <div class="val" id="product-min-required">-</div>
      </div>
      <div class="stat-box timer">
        <div class="label">å‰©é¤˜æ™‚é–“</div>
        <div class="val" id="product-countdown">--:--</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="bid-section">
      <h1>ğŸ’° æˆ‘è¦å‡ºåƒ¹</h1>
      <div class="input-group">
        <label for="inputBid">è¼¸å…¥å‡ºåƒ¹é‡‘é¡</label>
        <input id="inputBid" type="number" placeholder="ä¾‹å¦‚: 1500" />
      </div>
      <button class="action-btn" onclick="sendBid()">é€å‡ºå‡ºåƒ¹</button>
      <div id="send_output">æº–å‚™å°±ç·’</div>
      <div class="my-status-area">
        <h3>æˆ‘çš„ç‹€æ…‹</h3>
        <div id="myinfo">å°šæœªå‡ºåƒ¹</div>
      </div>
    </div>

    <div class="ranking-section">
      <h2>ğŸ† å³æ™‚æˆ°æ³æ’è¡Œæ¦œ</h2>
      <div class="ranking-header">
        <div>æ’å</div><div>ç”¨æˆ¶</div><div>å‡ºåƒ¹</div><div>ç©åˆ†</div><div>æ™‚é–“</div>
      </div>
      <div id="ranking" class="ranking-list">
        <div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>
      </div>
      <button class="refresh-rank-btn" onclick="loadBidList()">åˆ·æ–°æ’è¡Œæ¦œ</button>
    </div>
  </div>
</div>

<script>
const backend = "http://localhost:8000";
const currentUser = localStorage.getItem("username");
let userWeight = Number(localStorage.getItem("weight")) || 0; 

// é˜²å‘†èˆ‡ç‹€æ…‹è®Šæ•¸
let product = null;          // å­˜å•†å“åŸºæœ¬è³‡æ–™ (Name, Params)
let currentBids = [];        // å­˜æœ€æ–°çš„å‡ºåƒ¹åˆ—è¡¨ (Bids)
let hasNotified = false;     // æ§åˆ¶çµç®—å½ˆçª—æ˜¯å¦å·²é¡¯ç¤º
let lastStartTime = 0;       // ç”¨ä¾†åµæ¸¬æ˜¯å¦æ›äº†æ–°å•†å“

// æª¢æŸ¥ç™»å…¥
if(!currentUser){
    alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
    window.location.href = "login.html";
}

// åˆå§‹åŒ– UI
document.getElementById("disp-username").innerText = currentUser;
document.getElementById("disp-wins").innerText = userWeight;

function escapeHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

// åˆ·æ–°ç”¨æˆ¶æ¬Šé‡
async function refreshUserWeight(){
  try {
    let res = await fetch(`${backend}/api/user_info?username=${encodeURIComponent(currentUser)}`).then(r=>r.json());
    if(res.status === "ok"){
      userWeight = res.weight;
      localStorage.setItem("weight", res.weight);
      document.getElementById("disp-wins").innerText = res.weight;
    }
  } catch(e) {}
}

// ğŸ”¥ ä¿®æ­£ 1: loadProductInfo åªè² è²¬æŠ“ã€Œå•†å“éœæ…‹è³‡æ–™ã€èˆ‡ã€Œé‡ç½®ç‹€æ…‹ã€
async function loadProductInfo(){
  try {
    // é€™è£¡æ‹¿åˆ°çš„ product.bids å¯èƒ½æ˜¯èˆŠçš„ï¼Œæ‰€ä»¥æˆ‘å€‘ä¸ç”¨å®ƒä¾†ç®—éŒ¢
    const newProduct = await fetch(`${backend}/api/get_product`).then(r => r.json());

    // åµæ¸¬æ˜¯å¦æ›æ–°å•†å“ -> é‡ç½®é€šçŸ¥ç‹€æ…‹
    if (newProduct.start_time !== lastStartTime) {
        hasNotified = false; 
        lastStartTime = newProduct.start_time;
        if (!newProduct.settled) {
             document.getElementById("myinfo").innerText = "æ–°å•†å“ä¸Šæ¶ï¼Œå°šæœªå‡ºåƒ¹";
             document.getElementById("send_output").innerText = "æº–å‚™å°±ç·’";
        }
    }

    product = newProduct; // æ›´æ–°å…¨åŸŸè®Šæ•¸

    // æ›´æ–°åŸºæœ¬ UI
    document.getElementById("product-name").innerText = product.name || "ç­‰å¾…ä¸­...";
    document.getElementById("product-quantity").innerText = product.total_quantity;
    document.getElementById("product-min-required").innerText = product.base_price ?? "â€”";
    
    updateCountdown(); // ç«‹å³æ›´æ–°ä¸€æ¬¡æ™‚é–“

  } catch(e){ console.error(e); }
}

// ğŸ”¥ ä¿®æ­£ 2: ç¨ç«‹çš„åƒ¹æ ¼è¨ˆç®—å‡½å¼ (ä½¿ç”¨ loadBidList æŠ“å›ä¾†çš„æœ€æ–° bids)
function calculateEstimatedPrice(bids) {
    if (!product || product.settled) {
        document.getElementById("product-min-score-price").innerText = product && product.settled ? "å·²æˆªæ­¢" : "â€”";
        return;
    }

    const quantity = product.total_quantity;
    const scoreA = product.alpha || 3.0; // å¾ product æ‹¿ä¿‚æ•¸ (å¾Œç«¯å¿«å–)
    const scoreB = product.beta || 5.0;
    const scoreC = product.gamma || 3.0;
    
    // è¨ˆç®—é–€æª»åˆ†æ•¸ (é‚è¼¯ä¸è®Š)
    let sortedBids = [...bids].sort((a,b)=>b.score - a.score);
    let seenUsers = new Set();
    let winnerScores = [];
    
    for(let bid of sortedBids){
      if(!seenUsers.has(bid.user_id)){
        if (winnerScores.length < quantity) winnerScores.push(bid.score);
        seenUsers.add(bid.user_id);
      }
    }
    
    let minWinningScore = 0;
    if(quantity > 0 && winnerScores.length === quantity) {
        minWinningScore = winnerScores[quantity - 1];
    } else if (quantity > 0 && winnerScores.length > 0) {
        minWinningScore = Math.min(...winnerScores); 
    }

    let minRequiredPrice = "â€”";
    if (minWinningScore > 0 && scoreA > 0) {
        const now = Date.now();
        const T_ms = Math.max(0, now - (product.start_time || now)); 
        const W_est = 1; 
        
        // å…¬å¼ P = (S - C*W - B/(T+1)) / A
        const numerator = minWinningScore - (scoreC * W_est) - (scoreB / (T_ms + 1));
        let P_min = numerator / scoreA;
        P_min = Math.ceil(Math.max(product.base_price, P_min, 0)); 
        minRequiredPrice = P_min;
    } else {
        minRequiredPrice = product.base_price;
    }

    document.getElementById("product-min-score-price").innerText = minRequiredPrice;

    // æ›´æ–°æœ€é«˜åƒ¹
    const highest = bids.length ? Math.max(...bids.map(b=>b.bid_price)) : 0;
    document.getElementById("product-highest").innerText = highest > 0 ? highest : "â€”";
}

// æ›´æ–°å€’æ•¸è¨ˆæ™‚èˆ‡æ’è¡Œæ¦œæ™‚é–“
function updateCountdown(){
  if(!product || !product.start_time || !product.period) return;
  const now = Date.now();
  let remainMs = product.start_time + product.period - now;
  if(remainMs < 0) remainMs = 0;
  
  const minutes = Math.floor(remainMs / 60000);
  const seconds = Math.floor((remainMs % 60000)/1000);
  document.getElementById("product-countdown").innerText = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

  // æ›´æ–°æ’è¡Œæ¦œä¸­çš„æ™‚é–“æ¬„ä½ (Client-side è¨ˆç®—ï¼Œä¸ä¾è³´å¾Œç«¯)
  document.querySelectorAll(".rank-row").forEach(row => {
      const bidTime = Number(row.dataset.bidTime);
      if(bidTime) {
          let rem = Math.max(product.period - (bidTime - product.start_time), 0);
          const m = Math.floor(rem / 60000);
          const s = Math.floor((rem % 60000) / 1000);
          row.querySelector(".rank-time").textContent = `${m}åˆ†${s}ç§’`;
      }
  });
}

// ğŸ”¥ ä¿®æ­£ 3: æ’è¡Œæ¦œæ›´æ–° + è§¸ç™¼åƒ¹æ ¼è¨ˆç®—
async function loadBidList(){
  // å¦‚æœ product é‚„æ²’è¼‰å…¥ï¼Œå…ˆè¼‰å…¥ product
  if(!product) await loadProductInfo();

  try {
    const res = await fetch(`${backend}/api/bid_list`);
    const ranking = await res.json();
    currentBids = ranking; // æ›´æ–°å…¨åŸŸ bids

    // ğŸš€ é‡é»ï¼šæ‹¿åˆ°æœ€æ–° bids å¾Œï¼Œç«‹åˆ»é‡ç®—é ä¼°åƒ¹
    calculateEstimatedPrice(currentBids);

    const rankDiv = document.getElementById("ranking");

    if(ranking.length === 0) {
         rankDiv.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>`;
    } else {
        if(rankDiv.innerText.includes("æš«ç„¡å‡ºåƒ¹è³‡æ–™")) rankDiv.innerHTML = "";
        
        ranking.forEach((item, idx)=>{
          let row = rankDiv.children[idx]; 
          const displayScore = Number(item.score).toFixed(2);
          
          let timeStr = "--:--";
          if(product && item.timestamp){
              let rem = Math.max(product.period - (item.timestamp - product.start_time), 0);
              const m = Math.floor(rem / 60000);
              const s = Math.floor((rem % 60000) / 1000);
              timeStr = `${m}åˆ†${s}ç§’`;
          }

          if (row) {
            // æ›´æ–°ç¾æœ‰æ ¼å­
            row.dataset.bidTime = item.timestamp;
            const elUser = row.querySelector('.rank-user');
            const elPrice = row.querySelector('.rank-price');
            const elScore = row.querySelector('.rank-score');

            if(elUser.innerText !== item.user_id) elUser.innerText = item.user_id;
            if(elPrice.innerText !== `$${item.bid_price}`) elPrice.innerText = `$${item.bid_price}`;
            if(elScore.innerText !== displayScore) elScore.innerText = displayScore;
          } else {
            // å»ºç«‹æ–°æ ¼å­
            row = document.createElement("div");
            row.className = "rank-row";
            row.dataset.bidTime = item.timestamp;
            row.innerHTML = `
              <div><span class="rank-badge">${idx+1}</span></div>
              <div class="rank-user" title="${escapeHtml(item.user_id)}">${escapeHtml(item.user_id)}</div>
              <div class="rank-price">$${item.bid_price}</div>
              <div class="rank-score">${displayScore}</div>
              <div class="rank-time">${timeStr}</div> 
            `;
            rankDiv.appendChild(row);
          }
        });
        
        // ç§»é™¤å¤šé¤˜æ ¼å­
        while (rankDiv.children.length > ranking.length) {
          rankDiv.removeChild(rankDiv.lastChild);
        }
    }

    await updateMyInfo();
  } catch(err){ console.error(err); }
}

// ğŸ”¥ ä¿®æ­£ 4: æ”¹è‰¯çµç®—é€šçŸ¥é‚è¼¯
async function updateMyInfo(){
  try{
    const res = await fetch(`${backend}/api/get_bid_price?user_id=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    let info = "";
    if(data.message){
      if(product && !product.settled) info = "å°šæœªå‡ºåƒ¹";
      else info = data.message;
    } else {
      info = `æœ€é«˜å‡ºåƒ¹ï¼š$${data.highest_bid}\nç«¶æ¨™ç©åˆ†ï¼š${Number(data.score).toFixed(2)}`;
    }

    // --- çµç®—ç‹€æ…‹æª¢æŸ¥ ---
    // åªè¦ Redis èªª settled=trueï¼Œå°±æ˜¯çµæŸäº†
    if(product && product.settled){
      // 1. å…ˆé¡¯ç¤ºæ˜¯å¦åœ¨åå–®å…§ (å¦‚æœæœ‰ winner åå–®)
      if (Array.isArray(product.winner) && product.winner.length > 0) {
          const isWinner = product.winner.includes(currentUser);
          if(isWinner) info += "\nğŸ‰ æ­å–œï¼ä½ å¾—æ¨™äº†ï¼";
          else info += "\nå¾ˆéºæ†¾ï¼Œæœ¬æ¬¡æœªå¾—æ¨™";
      } else {
          // å¦‚æœ Redis å·²ç¶“ settled ä½† winner é‚„æ²’åŒæ­¥éä¾† (é‚„åœ¨ç©ºçª—æœŸ)
          info += "\n(çµç®—çµæœè¨ˆç®—ä¸­...)";
      }

      // 2. å½ˆçª—é€šçŸ¥ (åªå½ˆä¸€æ¬¡)
      if (!hasNotified) {
        if(Array.isArray(product.winner) && product.winner.includes(currentUser)){
           alert("ğŸ‰ æ­å–œï¼ä½ å·²ç¶“æˆåŠŸå¾—æ¨™ï¼");
        } else {
           alert("ğŸ”” ç«¶æ¨™å·²çµæŸï¼è«‹æŸ¥çœ‹çµæœã€‚");
        }
        hasNotified = true; // é–å®šï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡ product.start_time æ”¹è®Š
      }
    }
    
    document.getElementById("myinfo").innerText = info;
  } catch(err){}
}

async function sendBid(){
  const inputEl = document.getElementById("inputBid");
  const v = inputEl.value;
  if(!v && v!==0){ alert("è«‹è¼¸å…¥æ•¸å­—ï¼"); return; }
  
  if(product && product.settled){ alert("æœ¬å•†å“å·²çµæŸï¼Œç„¡æ³•å‡ºåƒ¹ï¼"); return; }
  if(product && Number(v) < product.base_price){ alert("ä½æ–¼æœ€ä½åƒ¹æ ¼!"); return; }

  try{
    const res = await fetch(`${backend}/api/bid`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:currentUser, bid_price:Number(v)})
    });
    const data = await res.json();
    if(data.status === "fail"){
        alert(data.message);
    } else {
        document.getElementById("send_output").innerText = "âœ… å‡ºåƒ¹æˆåŠŸï¼š$"+data.bid_price+" (ç©åˆ†:"+Number(data.score).toFixed(1)+")";
        inputEl.value = ""; 
        await loadBidList(); // å‡ºåƒ¹å¾Œç«‹åˆ»åˆ·æ–°
    }
  } catch(err){
    document.getElementById("send_output").innerText = "âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯";
  }
}

function logout(){
    if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")){
        localStorage.removeItem("username");
        localStorage.removeItem("weight");
        window.location.href = "login.html";
    }
}

// å•Ÿå‹•æµç¨‹
(async function init(){
  await refreshUserWeight();
  await loadProductInfo(); // å…ˆæŠ“ä¸€æ¬¡å•†å“
  
  // å®šæ™‚åˆ·æ–°
  setInterval(async ()=>{
    refreshUserWeight();
    
    // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡å•†å“ç‹€æ…‹ (çœ‹çœ‹æ˜¯ä¸æ˜¯ settled äº†ï¼Œæˆ–æ›æ–°å“äº†)
    // æ³¨æ„ï¼šé ä¼°åƒ¹è¨ˆç®—ç§»åˆ°äº† loadBidList å…§éƒ¨ï¼Œé€™è£¡ä¸ç”¨æ“”å¿ƒ
    loadProductInfo(); 
    
    updateCountdown();
    loadBidList();
  }, 1000);
})();
</script>
</body>
</html>