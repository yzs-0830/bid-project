<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«¶åƒ¹ç³»çµ±</title>
<style>
:root {
  /* ğŸ¨ é…è‰²ç³»çµ± */
  --primary: #2563eb;       /* ä¸»è‰²èª¿ï¼šé®®è±”è— */
  --primary-hover: #1d4ed8;
  --bg: #f1f5f9;            /* èƒŒæ™¯ï¼šæ·¡è—ç° */
  --card-bg: #ffffff;       /* å¡ç‰‡èƒŒæ™¯ï¼šç´”ç™½ */
  --text-main: #1e293b;     /* ä¸»æ–‡å­—ï¼šæ·±ç° */
  --text-muted: #64748b;    /* æ¬¡è¦æ–‡å­—ï¼šç° */
  --border: #e2e8f0;        /* é‚Šæ¡†è‰² */
  --danger: #ef4444;        /* è­¦å‘Š/ç™»å‡º */
  --success: #10b981;       /* æˆåŠŸ/é ˜å…ˆ */
  --accent: #f8fafc;        /* å¼·èª¿èƒŒæ™¯ */
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 16px;           /* åœ“è§’å¤§å° */
}

* { box-sizing: border-box; }

body {
  font-family: "Inter", "Segoe UI", system-ui, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 40px 20px;
  color: var(--text-main);
  line-height: 1.5;
}

/* --- ğŸŒŸ å´é‚Šæ¬„ (å·¦å´å›ºå®š) --- */
.user-sidebar {
  position: fixed;
  top: 40px;
  left: 20px;
  width: 220px;
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.user-sidebar .sidebar-header {
  border-bottom: 1px solid var(--border);
  padding-bottom: 15px;
  margin-bottom: 5px;
}

.user-sidebar .label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  font-weight: 600;
}

.user-sidebar .value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-main);
  margin-top: 4px;
}

.user-sidebar .value.wins {
  color: #d97706; /* ç¥ç€è‰² */
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-sidebar button {
  margin-top: auto;
  width: 100%;
  padding: 10px;
  background: transparent;
  color: var(--danger);
  border: 1px solid var(--danger);
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.user-sidebar button:hover {
  background: var(--danger);
  color: white;
}

/* --- ä¸»é é¢å®¹å™¨ --- */
.page {
  max-width: 1000px;
  margin: 0 auto;
  /* å·¦é‚Šé ç•™ç©ºé–“çµ¦å´é‚Šæ¬„ */
  margin-left: 260px; 
  margin-right: auto;
}

/* --- é ‚éƒ¨å•†å“è³‡è¨Š (æ”¹ç‚ºå„€è¡¨æ¿é¢¨æ ¼) --- */
.product-dashboard {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  border: 1px solid var(--border);
}

.product-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 16px;
}

.product-header h2 {
  margin: 0;
  font-size: 1.5rem;
  color: var(--primary);
}

.refresh-btn {
  background: var(--accent);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
}
.refresh-btn:hover { background: var(--border); color: var(--text-main); }

/* æ•¸æ“šæ–¹å¡Š Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
}

.stat-box {
  background: var(--bg);
  padding: 12px 16px;
  border-radius: 12px;
  text-align: center;
}

.stat-box .label {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.stat-box .val {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text-main);
}

.stat-box.highlight .val { color: var(--primary); }
.stat-box.timer .val { color: var(--danger); font-family: monospace; }

/* --- ä¸»å…§å®¹å€ (å·¦å³åˆ†æ¬„) --- */
.main-content {
  display: flex;
  gap: 24px;
  align-items: flex-start;
}

/* å·¦æ¬„ï¼šå‡ºåƒ¹å€ */
.bid-section {
  flex: 1;
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.bid-section h1 {
  margin: 0 0 20px 0;
  font-size: 1.25rem;
  color: var(--text-main);
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-muted);
}

.input-group input {
  width: 100%;
  padding: 12px 16px;
  font-size: 1rem;
  border: 2px solid var(--border);
  border-radius: 10px;
  margin-bottom: 16px;
  transition: border-color 0.2s;
  background: var(--accent);
}

.input-group input:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
}

.action-btn {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
}

.action-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
.action-btn:active { transform: translateY(1px); }

#send_output {
  margin-top: 16px;
  padding: 12px;
  border-radius: 8px;
  background: #f0fdf4; /* æ·ºç¶ èƒŒæ™¯ */
  border: 1px solid #bbf7d0;
  color: #166534;
  font-size: 0.9rem;
  min-height: 46px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

/* å³æ¬„ï¼šæ’è¡Œæ¦œ */
.ranking-section {
  flex: 0 0 380px;
  background: var(--card-bg);
  padding: 0; /* å…§éƒ¨ padding ç”±å­å…ƒç´ è™•ç† */
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden; /* ç¢ºä¿åœ“è§’ */
}

.ranking-header-area {
  padding: 20px 20px 10px 20px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.ranking-header-area h2 {
  margin: 0;
  font-size: 1.1rem;
  color: var(--text-main);
}

.ranking-list {
  max-height: 350px;
  overflow-y: auto;
  padding: 0;
}

.rank-row {
  display: grid;
  grid-template-columns: 40px 1fr auto auto; /* æ’å, ç”¨æˆ¶, åƒ¹æ ¼, åˆ†æ•¸ */
  gap: 10px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  font-size: 0.9rem;
  transition: background 0.1s;
}

.rank-row:last-child { border-bottom: none; }
.rank-row:hover { background: var(--accent); }

.rank-badge {
  width: 28px;
  height: 28px;
  background: #e2e8f0;
  color: #64748b;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.8rem;
}

/* å‰ä¸‰åé¡è‰² */
.rank-row:nth-child(1) .rank-badge { background: #fef08a; color: #b45309; } /* é‡‘ */
.rank-row:nth-child(2) .rank-badge { background: #e2e8f0; color: #475569; } /* éŠ€ */
.rank-row:nth-child(3) .rank-badge { background: #fed7aa; color: #c2410c; } /* éŠ… */

.rank-user { font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rank-price { color: var(--primary); font-weight: 700; }
.rank-score { color: var(--text-muted); font-size: 0.85rem; }

/* ç”¨æˆ¶ç‹€æ…‹å€å¡Š */
.my-status-area {
  padding: 15px 20px;
  background: #eff6ff;
  border-top: 1px solid #dbeafe;
}
.my-status-area h3 { margin: 0 0 8px 0; font-size: 0.9rem; color: var(--primary); }
#myinfo { font-size: 0.9rem; color: #334155; white-space: pre-wrap; line-height: 1.4; }

.refresh-rank-btn {
  width: 100%;
  padding: 12px;
  background: var(--bg);
  border: none;
  border-top: 1px solid var(--border);
  color: var(--text-muted);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: background 0.2s;
}
.refresh-rank-btn:hover { background: #e2e8f0; color: var(--text-main); }


/* --- RWD éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
@media (max-width: 1100px) {
  .user-sidebar {
    position: static;
    width: 100%;
    margin-bottom: 24px;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
  }
  
  .user-sidebar .sidebar-header { border-bottom: none; margin-bottom: 0; padding-bottom: 0; display: flex; align-items: center; gap: 20px;}
  .user-sidebar button { width: auto; margin-top: 0; padding: 8px 24px; }
  
  .page { margin-left: auto; margin-right: auto; }
}

@media (max-width: 800px) {
  .main-content { flex-direction: column; }
  .ranking-section { width: 100%; flex: auto; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>

<body>

<div class="user-sidebar">
  <div class="sidebar-header">
    <div>
      <div class="label">User ID</div>
      <div class="value" id="disp-username">--</div>
    </div>
  </div>
  <div class="sidebar-header" style="border-bottom:none; margin-bottom:0;">
    <div>
      <div class="label">Total Wins</div>
      <div class="value wins">
        <span>ğŸ†</span>
        <span id="disp-wins">0</span>
      </div>
    </div>
  </div>
  <button onclick="logout()">ç™»å‡ºç³»çµ±</button>
</div>

<div class="page">
  
  <div class="product-dashboard" id="product-info">
    <div class="product-header">
      <h2 id="product-name">è¼‰å…¥ä¸­...</h2>
      <button class="refresh-btn" onclick="loadProductInfo()">â†» åˆ·æ–°è³‡è¨Š</button>
    </div>
    
    <div class="stats-grid">
      <div class="stat-box">
        <div class="label">åº«å­˜æ•¸é‡</div>
        <div class="val" id="product-quantity">-</div>
      </div>
      <div class="stat-box highlight">
        <div class="label">ç›®å‰æœ€é«˜åƒ¹</div>
        <div class="val" id="product-highest">-</div>
      </div>
      <div class="stat-box">
        <div class="label">å¾—æ¨™é ä¼°åƒ¹</div>
        <div class="val" id="product-min-score-price">-</div>
      </div>
      <div class="stat-box">
        <div class="label">æœ€ä½åº•åƒ¹</div>
        <div class="val" id="product-min-required">-</div>
      </div>
      <div class="stat-box timer">
        <div class="label">å‰©é¤˜æ™‚é–“</div>
        <div class="val" id="product-countdown">--:--</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    
    <div class="bid-section">
      <h1>ğŸ’° æˆ‘è¦å‡ºåƒ¹</h1>
      <div class="container">
        <div class="input-group">
          <label for="inputBid">è¼¸å…¥å‡ºåƒ¹é‡‘é¡</label>
          <input id="inputBid" type="number" placeholder="ä¾‹å¦‚: 1500" />
        </div>
        <button class="action-btn" onclick="sendBid()">é€å‡ºå‡ºåƒ¹</button>
        <div id="send_output">æº–å‚™å°±ç·’</div>
      </div>
    </div>

    <div class="ranking-section">
      <div class="ranking-header-area">
        <h2>ğŸ† å³æ™‚æˆ°æ³</h2>
      </div>
      
      <div id="ranking" class="ranking-list">
        <div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>
      </div>

      <div class="my-status-area">
        <h3>æˆ‘çš„ç‹€æ…‹</h3>
        <div id="myinfo">å°šæœªå‡ºåƒ¹</div>
      </div>

      <button class="refresh-rank-btn" onclick="loadBidList()">åˆ·æ–°æ’è¡Œæ¦œ</button>
    </div>

  </div>
</div>

<script>
const backend = "http://localhost:8000";

// ğŸŒŸ å¾ localStorage å–å¾—ç™»å…¥ä½¿ç”¨è€…
const currentUser = localStorage.getItem("username");
let userWeight = Number(localStorage.getItem("weight")) || 0; 

if(!currentUser){
    alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
    window.location.href = "login.html";
}

// å‰ç«¯åƒæ•¸
let product = null;
let hasNotified = false;
let lastStartTime = 0;

// åˆå§‹åŒ–å´é‚Šæ¬„é¡¯ç¤º
document.getElementById("disp-username").innerText = currentUser;
document.getElementById("disp-wins").innerText = userWeight;

// HTML escape
function escapeHtml(str) {
  return String(str).replace(/&/g,"&amp;")
                    .replace(/</g,"&lt;")
                    .replace(/>/g,"&gt;")
                    .replace(/"/g,"&quot;")
                    .replace(/'/g,"&#039;");
}

// æ›´æ–°weight
async function refreshUserWeight(){
  try {
    let res = await fetch(`${backend}/api/user_info?username=${encodeURIComponent(currentUser)}`).then(r=>r.json());
    if(res.status === "ok"){
      userWeight = res.weight;
      localStorage.setItem("weight", res.weight);
      document.getElementById("disp-wins").innerText = res.weight;
    }
  } catch(e) {
    console.error("æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—", e);
  }
}

// å–å¾—å•†å“è³‡è¨Š
async function loadProductInfo(){
  try {
    product = await fetch(`${backend}/api/get_product`).then(r => r.json());
    // å¦‚æœéœ€è¦é¡¯ç¤ºåˆ†æ•¸åƒæ•¸ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡ fetch score
    let score = { A:1, B:1, C:1 }; // é è¨­å€¼ï¼Œè‹¥éœ€è¦ç²¾æº–è¨ˆç®—å»ºè­° fetch
    try {
        score = await fetch(`${backend}/api/get_score`).then(r => r.json());
    } catch(e){}

    if (product.start_time !== lastStartTime) {
        hasNotified = false;
        lastStartTime = product.start_time;
        if (!product.settled) {
             document.getElementById("myinfo").innerText = "æ–°å•†å“ä¸Šæ¶ï¼Œå°šæœªå‡ºåƒ¹";
             document.getElementById("send_output").innerText = "æº–å‚™å°±ç·’";
        }
    }

    document.getElementById("product-name").innerText = product.name || "ç­‰å¾…ä¸­...";
    document.getElementById("product-quantity").innerText = product.total_quantity;
    
    // è¨ˆç®—é‚è¼¯ä¿æŒä¸è®Š
    const quantity = product.total_quantity;
    const bids = product.bids || [];
    let sortedBids = [...bids].sort((a,b)=>b.score - a.score);
    let seenUsers = new Set();
    let winnersPrice = [];
    let winnerScores = [];

    for(let bid of sortedBids){
      if(!seenUsers.has(bid.user_id)){
        if (winnersPrice.length < quantity) {
            winnersPrice.push(bid.bid_price);
            winnerScores.push(bid.score);
        }
        seenUsers.add(bid.user_id);
      }
    }
    
    let minWinningScore = 0;
    if(quantity > 0 && winnerScores.length === quantity) {
        minWinningScore = winnerScores[quantity - 1];
    } else if (quantity > 0 && winnerScores.length > 0) {
        minWinningScore = Math.min(...winnerScores); 
    }
    
    let minRequiredPrice = "â€”";

    // åˆ¤æ–·ï¼šå¦‚æœå•†å“å·²çµç®—ï¼Œå°±ä¸ç®—é ä¼°åƒ¹äº†
    if (product.settled) {
        minRequiredPrice = "å·²æˆªæ­¢"; 
    } else {
        // åªæœ‰åœ¨ã€Œæœªçµç®—ã€æ™‚æ‰è¨ˆç®—
        const now = Date.now();
        const T_ms = Math.max(0, now - (product.start_time || now)); 
        const W_est = 1; // é ä¼°æ¬Šé‡

        if (minWinningScore > 0 && score.A > 0) {
            const A = score.A;
            const B = score.B;
            const C = score.C;
            const numerator = minWinningScore - (C * W_est) - (B / (T_ms + 1));
            let P_min = numerator / A;
            P_min = Math.ceil(Math.max(product.base_price, P_min, 0)); 
            minRequiredPrice = P_min;
        } else {
            // å¦‚æœé‚„æ²’äººå‡ºåƒ¹ï¼Œæˆ–æ˜¯åˆ†æ•¸ä¸å¤ ï¼Œé¡¯ç¤ºåº•åƒ¹å³å¯
            minRequiredPrice = product.base_price;
        }
    }

    document.getElementById("product-min-score-price").innerText = minRequiredPrice;
    document.getElementById("product-min-required").innerText = product.base_price ?? "â€”";
    
    // æœ€é«˜åƒ¹æ›´æ–°
    const highest = bids.length ? Math.max(...bids.map(b=>b.bid_price)) : 0;
    document.getElementById("product-highest").innerText = highest > 0 ? highest : "â€”";

    updateCountdown();
  } catch(e){
    console.error(e);
  }
}

// å€’æ•¸æ™‚é–“
function updateCountdown(){
  if(!product || !product.start_time || !product.period) return;
  const now = Date.now();
  let remainMs = product.start_time + product.period - now;
  if(remainMs < 0) remainMs = 0;
  const minutes = Math.floor(remainMs / 60000);
  const seconds = Math.floor((remainMs % 60000)/1000);
  document.getElementById("product-countdown").innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
}

// æ’è¡Œæ¦œæ›´æ–°
async function loadBidList(){
  if(!product) await loadProductInfo();
  try {
    const res = await fetch(`${backend}/api/bid_list`);
    const ranking = await res.json();
    const rankDiv = document.getElementById("ranking");
    rankDiv.innerHTML = ""; 

    if(ranking.length === 0) {
         rankDiv.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>`;
    } else {
        ranking.forEach((item, idx)=>{
          const row = document.createElement("div");
          row.className = "rank-row";
          row.dataset.user = item.user_id;
          const displayScore = Number(item.score).toFixed(2);
          
          row.innerHTML = `
            <div class="rank-badge">${idx+1}</div>
            <div class="rank-user" title="${escapeHtml(item.user_id)}">${escapeHtml(item.user_id)}</div>
            <div class="rank-price">$${item.bid_price}</div>
            <div class="rank-score">${displayScore}</div>
          `;
          rankDiv.appendChild(row);
        });
    }

    await updateMyInfo();
  } catch(err){
    console.error(err);
  }
}

// æˆ‘çš„å‡ºåƒ¹è³‡è¨Š
async function updateMyInfo(){
  try{
    const res = await fetch(`${backend}/api/get_bid_price?user_id=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    let info = "";
    if(data.message){
      // æœªå‡ºåƒ¹
      if(product && !product.settled) info = "å°šæœªå‡ºåƒ¹";
      else info = data.message;
    } else {
      info = `æœ€é«˜å‡ºåƒ¹ï¼š$${data.highest_bid}\nç«¶æ¨™ç©åˆ†ï¼š${Number(data.score).toFixed(2)}`;
    }

    if(product && product.settled && Array.isArray(product.winner)){
      const isWinner = product.winner.includes(currentUser);

      if(isWinner){
        info += "\nğŸ‰ æ­å–œï¼ä½ å¾—æ¨™äº†ï¼";
      } else {
        info += "\nğŸ˜­ å¾ˆéºæ†¾ï¼Œæœ¬æ¬¡æœªå¾—æ¨™";
      }

      if (!hasNotified) {
        if(isWinner){
          alert("ğŸ‰ æ­å–œï¼ä½ å·²ç¶“æˆåŠŸå¾—æ¨™ï¼");
        } else {
          alert("ğŸ˜­ æ¯”è³½çµæŸï¼Œå¾ˆéºæ†¾æœ¬æ¬¡æœªå¾—æ¨™ã€‚\nå†æ¥å†å²ï¼");
        }
        hasNotified = true; 
      }
    } else if (product && !product.settled) {
       // ç«¶æ¨™ä¸­
    } else {
      hasNotified = false;
    }

    document.getElementById("myinfo").innerText = info;
  } catch(err){
    // error
  }
}

// é€å‡ºå‡ºåƒ¹
async function sendBid(){
  const inputEl = document.getElementById("inputBid");
  const v = inputEl.value;
  if(!v && v!==0){ alert("è«‹è¼¸å…¥æ•¸å­—ï¼"); return; }
  
  if(product && product.settled){
    alert("æœ¬å•†å“å·²çµæŸï¼Œç„¡æ³•å‡ºåƒ¹ï¼");
    return;
  }
  if(product && Number(v) < product.base_price){
    alert("ä½æ–¼æœ€ä½åƒ¹æ ¼!");
    return;
  }

  try{
    const res = await fetch(`${backend}/api/bid`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:currentUser, bid_price:Number(v)})
    });
    const data = await res.json();
    if(data.status === "fail"){
        alert(data.message);
    } else {
        document.getElementById("send_output").innerText = "âœ… å‡ºåƒ¹æˆåŠŸï¼š$"+data.bid_price+" (ç©åˆ†:"+Number(data.score).toFixed(1)+")";
        inputEl.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
        await loadBidList();
    }
  } catch(err){
    console.error(err);
    document.getElementById("send_output").innerText = "âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯";
  }
}

function logout(){
    if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")){
        localStorage.removeItem("username");
        localStorage.removeItem("weight");
        window.location.href = "login.html";
    }
}

(async function init(){
  await refreshUserWeight();
  await loadProductInfo();
  
  setInterval(async ()=>{
    refreshUserWeight();
    loadProductInfo();
    updateCountdown();
    loadBidList();
  },1000);
})();
</script>
</body>
</html>