<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«¶åƒ¹ç³»çµ± - ç”¨æˆ¶ç«¯</title>
<style>
/* --- å…¨å±€è®Šæ•¸è¨­å®š --- */
:root {
  --primary: #2563eb;       /* ä¸»è‰²èª¿ï¼šé®®è±”è— */
  --primary-hover: #1d4ed8;
  --bg: #f8fafc;            /* èƒŒæ™¯ï¼šæ›´æ˜äº®çš„ç°ç™½ */
  --card-bg: #ffffff;       /* å¡ç‰‡èƒŒæ™¯ï¼šç´”ç™½ */
  --text-main: #0f172a;     /* ä¸»æ–‡å­—ï¼šæ·±è—ç° */
  --text-muted: #64748b;    /* æ¬¡è¦æ–‡å­—ï¼šç° */
  --border: #e2e8f0;        /* é‚Šæ¡†è‰² */
  --danger: #ef4444;        /* è­¦å‘Š/ç™»å‡º */
  --success: #10b981;       /* æˆåŠŸ */
  --accent: #f1f5f9;        /* å¼·èª¿èƒŒæ™¯ */
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 12px;           /* åœ“è§’å¤§å° */
}

* { box-sizing: border-box; }

body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 40px 20px;
  color: var(--text-main);
  line-height: 1.5;
}

/* --- ğŸŒŸ å·¦å´å´é‚Šæ¬„ --- */
.user-sidebar {
  position: fixed;
  top: 40px;
  left: 20px;
  width: 240px;
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.user-sidebar .sidebar-row {
  display: flex;
  flex-direction: column;
  gap: 4px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 16px;
}
.user-sidebar .sidebar-row:last-of-type {
  border-bottom: none;
}

.user-sidebar .label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  font-weight: 700;
}

.user-sidebar .value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-main);
}

.user-sidebar .value.wins {
  color: #d97706; /* çç›ƒé‡‘é»ƒè‰² */
  display: flex;
  align-items: center;
  gap: 8px;
}

.logout-btn {
  margin-top: auto;
  width: 100%;
  padding: 12px;
  background: white;
  color: var(--danger);
  border: 1px solid var(--danger);
  border-radius: 8px;
  font-size: 0.95rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}
.logout-btn:hover { background: var(--danger); color: white; }

/* --- ä¸»é é¢å®¹å™¨ (å³ç§»ä»¥é¿é–‹å´é‚Šæ¬„) --- */
.page {
  max-width: 1100px;
  margin: 0 auto;
  margin-left: 280px; /* ç•™çµ¦å´é‚Šæ¬„çš„ç©ºé–“ */
  margin-right: auto;
}

/* --- ä¸Šæ–¹ï¼šå•†å“è³‡è¨Šå„€è¡¨æ¿ --- */
.product-dashboard {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  border: 1px solid var(--border);
}

.product-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 16px;
}

.product-header h2 { margin: 0; font-size: 1.5rem; color: var(--primary); }

.refresh-btn {
  background: var(--accent);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.2s;
}
.refresh-btn:hover { background: var(--border); color: var(--text-main); }

/* å„€è¡¨æ¿ Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
}

.stat-box {
  background: var(--bg);
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  border: 1px solid transparent;
}

.stat-box .label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
.stat-box .val { font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
.stat-box.highlight { background: #eff6ff; border-color: #dbeafe; }
.stat-box.highlight .val { color: var(--primary); }
.stat-box.timer .val { color: var(--danger); font-family: monospace; letter-spacing: 1px; }

/* --- ä¸‹æ–¹ï¼šä¸»å…§å®¹å€ (å·¦å³åˆ†æ¬„) --- */
.main-content {
  display: flex;
  gap: 24px;
  align-items: flex-start;
}

/* å·¦æ¬„ï¼šå‡ºåƒ¹æ“ä½œ */
.bid-section {
  flex: 0 0 340px; /* å›ºå®šå¯¬åº¦ */
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.bid-section h1 { margin: 0 0 20px 0; font-size: 1.25rem; color: var(--text-main); }

.input-group { margin-bottom: 20px; }
.input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); }
.input-group input {
  width: 100%;
  padding: 12px 16px;
  font-size: 1.1rem;
  border: 2px solid var(--border);
  border-radius: 8px;
  transition: border-color 0.2s;
  background: var(--bg);
}
.input-group input:focus { outline: none; border-color: var(--primary); background: white; }

.action-btn {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
  transition: transform 0.1s, background 0.2s;
}
.action-btn:hover { background: var(--primary-hover); }
.action-btn:active { transform: translateY(1px); }

#send_output {
  margin-top: 16px;
  padding: 12px;
  border-radius: 8px;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  color: #166534;
  font-size: 0.9rem;
  min-height: 48px;
  display: flex; align-items: center; justify-content: center; text-align: center;
}

.my-status-area {
  margin-top: 24px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}
.my-status-area h3 { margin: 0 0 8px 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
#myinfo { font-size: 0.95rem; color: #334155; white-space: pre-wrap; line-height: 1.6; }


/* å³æ¬„ï¼šæ’è¡Œæ¦œ (å®Œå…¨å°é½Šå¾Œå°æ¨£å¼) */
.ranking-section {
  flex: 1;
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.ranking-section h2 { margin: 0 0 15px 0; font-size: 1.25rem; color: var(--text-main); }

/* ğŸ”¥ Grid æ’ç‰ˆè¨­å®šï¼šèˆ‡æ¨™é¡Œåˆ—å°é½Š */
.ranking-header {
  display: grid;
  grid-template-columns: 60px 1fr 100px 80px 100px; /* æ’å | ç”¨æˆ¶ | å‡ºåƒ¹ | ç©åˆ† | æ™‚é–“ */
  padding: 12px 16px;
  background: #f1f5f9;
  border-radius: 8px;
  font-weight: 700;
  color: #64748b;
  font-size: 0.9rem;
  margin-bottom: 12px;
}

.ranking-list { max-height: 450px; overflow-y: auto; }

.rank-row {
  display: grid;
  grid-template-columns: 60px 1fr 100px 80px 100px; /* å¿…é ˆèˆ‡ header ä¸€è‡´ */
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  font-size: 0.95rem;
  transition: background 0.1s;
}
.rank-row:hover { background: #f8fafc; }
.rank-row:last-child { border-bottom: none; }

/* æ’åå¾½ç«  */
.rank-badge {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.8rem; background: #e2e8f0; color: #64748b;
}
.rank-row:nth-child(1) .rank-badge { background: #ffd700; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.15); } /* é‡‘ */
.rank-row:nth-child(2) .rank-badge { background: #c0c0c0; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.15); } /* éŠ€ */
.rank-row:nth-child(3) .rank-badge { background: #cd7f32; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.15); } /* éŠ… */

.rank-user { font-weight: 600; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rank-price { font-weight: 700; color: var(--primary); }
.rank-score { font-weight: 700; color: #d97706; }
.rank-time { font-size: 0.85rem; color: #94a3b8; }

.refresh-rank-btn {
  width: 100%; margin-top: 15px; padding: 12px;
  background: var(--bg); border: none; border-radius: 8px;
  color: var(--text-muted); cursor: pointer; font-weight: 600;
  transition: background 0.2s;
}
.refresh-rank-btn:hover { background: #e2e8f0; color: var(--text-main); }

/* --- RWD éŸ¿æ‡‰å¼ --- */
@media (max-width: 1100px) {
  .user-sidebar {
    position: static; width: 100%; margin-bottom: 24px;
    flex-direction: row; justify-content: space-between; align-items: center;
    padding: 16px 24px;
  }
  .user-sidebar .sidebar-row { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
  .logout-btn { width: auto; margin-top: 0; padding: 8px 24px; }
  
  .page { margin-left: auto; margin-right: auto; }
}

@media (max-width: 900px) {
  .main-content { flex-direction: column-reverse; }
  .bid-section, .ranking-section { width: 100%; flex: auto; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>

<body>

<div class="user-sidebar">
  <div class="sidebar-row">
    <div class="label">User ID</div>
    <div class="value" id="disp-username">--</div>
  </div>
  <div class="sidebar-row">
    <div class="label">Total Wins</div>
    <div class="value wins">
      <span>ğŸ†</span>
      <span id="disp-wins">0</span>
    </div>
  </div>
  <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>
</div>

<div class="page">
  
  <div class="product-dashboard" id="product-info">
    <div class="product-header">
      <h2 id="product-name">è¼‰å…¥ä¸­...</h2>
      <button class="refresh-btn" onclick="loadProductInfo()">â†» åˆ·æ–°è³‡è¨Š</button>
    </div>
    
    <div class="stats-grid">
      <div class="stat-box">
        <div class="label">åº«å­˜æ•¸é‡</div>
        <div class="val" id="product-quantity">-</div>
      </div>
      <div class="stat-box highlight">
        <div class="label">ç›®å‰æœ€é«˜åƒ¹</div>
        <div class="val" id="product-highest">-</div>
      </div>
      <div class="stat-box">
        <div class="label">å¾—æ¨™é ä¼°åƒ¹</div>
        <div class="val" id="product-min-score-price">-</div>
      </div>
      <div class="stat-box">
        <div class="label">æœ€ä½åº•åƒ¹</div>
        <div class="val" id="product-min-required">-</div>
      </div>
      <div class="stat-box timer">
        <div class="label">å‰©é¤˜æ™‚é–“</div>
        <div class="val" id="product-countdown">--:--</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    
    <div class="bid-section">
      <h1>ğŸ’° æˆ‘è¦å‡ºåƒ¹</h1>
      <div class="input-group">
        <label for="inputBid">è¼¸å…¥å‡ºåƒ¹é‡‘é¡</label>
        <input id="inputBid" type="number" placeholder="ä¾‹å¦‚: 1500" />
      </div>
      <button class="action-btn" onclick="sendBid()">é€å‡ºå‡ºåƒ¹</button>
      <div id="send_output">æº–å‚™å°±ç·’</div>

      <div class="my-status-area">
        <h3>æˆ‘çš„ç‹€æ…‹</h3>
        <div id="myinfo">å°šæœªå‡ºåƒ¹</div>
      </div>
    </div>

    <div class="ranking-section">
      <h2>ğŸ† å³æ™‚æˆ°æ³æ’è¡Œæ¦œ</h2>
      
      <div class="ranking-header">
        <div>æ’å</div>
        <div>ç”¨æˆ¶</div>
        <div>å‡ºåƒ¹</div>
        <div>ç©åˆ†</div>
        <div>æ™‚é–“</div>
      </div>
      
      <div id="ranking" class="ranking-list">
        <div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>
      </div>

      <button class="refresh-rank-btn" onclick="loadBidList()">åˆ·æ–°æ’è¡Œæ¦œ</button>
    </div>

  </div>
</div>

<script>
const backend = "http://localhost:8000";
const currentUser = localStorage.getItem("username");
let userWeight = Number(localStorage.getItem("weight")) || 0; 

// æª¢æŸ¥ç™»å…¥
if(!currentUser){
    alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
    window.location.href = "login.html";
}

let product = null;
let hasNotified = false;
let lastStartTime = 0;

// åˆå§‹åŒ–å´é‚Šæ¬„
document.getElementById("disp-username").innerText = currentUser;
document.getElementById("disp-wins").innerText = userWeight;

function escapeHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

async function refreshUserWeight(){
  try {
    let res = await fetch(`${backend}/api/user_info?username=${encodeURIComponent(currentUser)}`).then(r=>r.json());
    if(res.status === "ok"){
      userWeight = res.weight;
      localStorage.setItem("weight", res.weight);
      document.getElementById("disp-wins").innerText = res.weight;
    }
  } catch(e) {}
}

async function loadProductInfo(){
  try {
    product = await fetch(`${backend}/api/get_product`).then(r => r.json());
    // é è¨­åˆ†æ•¸åƒæ•¸ï¼Œæ­£å¼ç‰ˆå»ºè­°å¾å¾Œç«¯ fetch
    let score = { A:3, B:5, C:3 }; 
    try { score = await fetch(`${backend}/api/get_score`).then(r => r.json()); } catch(e){}

    // æª¢æŸ¥æ˜¯å¦æ–°å•†å“
    if (product.start_time !== lastStartTime) {
        hasNotified = false;
        lastStartTime = product.start_time;
        if (!product.settled) {
             document.getElementById("myinfo").innerText = "æ–°å•†å“ä¸Šæ¶ï¼Œå°šæœªå‡ºåƒ¹";
             document.getElementById("send_output").innerText = "æº–å‚™å°±ç·’";
        }
    }

    document.getElementById("product-name").innerText = product.name || "ç­‰å¾…ä¸­...";
    document.getElementById("product-quantity").innerText = product.total_quantity;
    
    // --- è¨ˆç®—å¾—æ¨™é ä¼°åƒ¹ P_min ---
    const quantity = product.total_quantity;
    const bids = product.bids || [];
    // ç°¡å–®æ‰¾å‡ºç›®å‰å¾—æ¨™é–€æª»åˆ†æ•¸
    let sortedBids = [...bids].sort((a,b)=>b.score - a.score);
    let seenUsers = new Set();
    let winnerScores = [];
    for(let bid of sortedBids){
      if(!seenUsers.has(bid.user_id)){
        if (winnerScores.length < quantity) winnerScores.push(bid.score);
        seenUsers.add(bid.user_id);
      }
    }
    
    let minWinningScore = 0;
    if(quantity > 0 && winnerScores.length === quantity) {
        minWinningScore = winnerScores[quantity - 1];
    } else if (quantity > 0 && winnerScores.length > 0) {
        minWinningScore = Math.min(...winnerScores); 
    }
    
    let minRequiredPrice = "â€”";
    if (product.settled) {
        minRequiredPrice = "å·²æˆªæ­¢"; 
    } else {
        const now = Date.now();
        const T_ms = Math.max(0, now - (product.start_time || now)); 
        const W_est = 1; 
        if (minWinningScore > 0 && score.A > 0) {
            const numerator = minWinningScore - (score.C * W_est) - (score.B / (T_ms + 1));
            let P_min = numerator / score.A;
            P_min = Math.ceil(Math.max(product.base_price, P_min, 0)); 
            minRequiredPrice = P_min;
        } else {
            minRequiredPrice = product.base_price;
        }
    }

    document.getElementById("product-min-score-price").innerText = minRequiredPrice;
    document.getElementById("product-min-required").innerText = product.base_price ?? "â€”";
    
    const highest = bids.length ? Math.max(...bids.map(b=>b.bid_price)) : 0;
    document.getElementById("product-highest").innerText = highest > 0 ? highest : "â€”";

    updateCountdown();
  } catch(e){ console.error(e); }
}

function updateCountdown(){
  if(!product || !product.start_time || !product.period) return;
  const now = Date.now();
  let remainMs = product.start_time + product.period - now;
  if(remainMs < 0) remainMs = 0;
  const minutes = Math.floor(remainMs / 60000);
  const seconds = Math.floor((remainMs % 60000)/1000);
  document.getElementById("product-countdown").innerText = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

  // æ›´æ–°æ’è¡Œæ¦œä¸­çš„æ™‚é–“æ¬„ä½
  document.querySelectorAll(".rank-row").forEach(row => {
      const bidTime = Number(row.dataset.bidTime);
      if(bidTime) {
          let rem = Math.max(product.period - (bidTime - product.start_time), 0);
          const m = Math.floor(rem / 60000);
          const s = Math.floor((rem % 60000) / 1000);
          row.querySelector(".rank-time").textContent = `${m}åˆ†${s}ç§’`;
      }
  });
}

// æ’è¡Œæ¦œæ›´æ–° (é˜²é–ƒçˆç‰ˆæœ¬)
async function loadBidList(){
  if(!product) await loadProductInfo();
  try {
    const res = await fetch(`${backend}/api/bid_list`);
    const ranking = await res.json();
    const rankDiv = document.getElementById("ranking");

    // 1. è™•ç†ç„¡è³‡æ–™ç‹€æ…‹
    if(ranking.length === 0) {
         rankDiv.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8;">æš«ç„¡å‡ºåƒ¹è³‡æ–™</div>`;
         return;
    }
    // è‹¥ä¹‹å‰é¡¯ç¤º"æš«ç„¡è³‡æ–™"ï¼Œå…ˆæ¸…ç©º
    if(rankDiv.innerText.includes("æš«ç„¡å‡ºåƒ¹è³‡æ–™")) rankDiv.innerHTML = "";

    // 2. éæ­·è³‡æ–™ä¸¦æ›´æ–°
    ranking.forEach((item, idx)=>{
      let row = rankDiv.children[idx]; // å˜—è©¦ç²å–ç¾æœ‰æ ¼å­
      const displayScore = Number(item.score).toFixed(2);
      
      // è¨ˆç®—åˆå§‹æ™‚é–“å­—ä¸² (é¿å…å‰›è¼‰å…¥é¡¯ç¤º --:--)
      let timeStr = "--:--";
      if(product && item.timestamp){
          let rem = Math.max(product.period - (item.timestamp - product.start_time), 0);
          const m = Math.floor(rem / 60000);
          const s = Math.floor((rem % 60000) / 1000);
          timeStr = `${m}åˆ†${s}ç§’`;
      }

      if (row) {
        // [æƒ…æ³ A] æ ¼å­å·²å­˜åœ¨ -> ç›´æ¥ä¿®æ”¹æ–‡å­— (é˜²é–ƒçˆé—œéµ ğŸ”¥)
        row.dataset.bidTime = item.timestamp;
        
        // åªæœ‰å…§å®¹è®Šå‹•æ‰æ›´æ–°ï¼Œæå‡æ•ˆèƒ½
        const elUser = row.querySelector('.rank-user');
        const elPrice = row.querySelector('.rank-price');
        const elScore = row.querySelector('.rank-score');

        if(elUser.innerText !== item.user_id) elUser.innerText = item.user_id;
        if(elPrice.innerText !== `$${item.bid_price}`) elPrice.innerText = `$${item.bid_price}`;
        if(elScore.innerText !== displayScore) elScore.innerText = displayScore;
        // æ™‚é–“æ¬„ä½ç”± updateCountdown çµ±ä¸€è™•ç†ï¼Œé€™è£¡ä¸æ›´å‹•
        
      } else {
        // [æƒ…æ³ B] æ ¼å­ä¸å­˜åœ¨ -> å»ºç«‹æ–°å…ƒç´ 
        row = document.createElement("div");
        row.className = "rank-row";
        row.dataset.bidTime = item.timestamp;
        
        row.innerHTML = `
          <div><span class="rank-badge">${idx+1}</span></div>
          <div class="rank-user" title="${escapeHtml(item.user_id)}">${escapeHtml(item.user_id)}</div>
          <div class="rank-price">$${item.bid_price}</div>
          <div class="rank-score">${displayScore}</div>
          <div class="rank-time">${timeStr}</div> 
        `;
        rankDiv.appendChild(row);
      }
    });

    // 3. æ¸…ç†å¤šé¤˜çš„æ ¼å­ (ä¾‹å¦‚æ’åäººæ•¸è®Šå°‘æ™‚)
    while (rankDiv.children.length > ranking.length) {
      rankDiv.removeChild(rankDiv.lastChild);
    }

    await updateMyInfo();
  } catch(err){ console.error(err); }
}

async function updateMyInfo(){
  try{
    const res = await fetch(`${backend}/api/get_bid_price?user_id=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    let info = "";
    if(data.message){
      if(product && !product.settled) info = "å°šæœªå‡ºåƒ¹";
      else info = data.message;
    } else {
      info = `æœ€é«˜å‡ºåƒ¹ï¼š$${data.highest_bid}\nç«¶æ¨™ç©åˆ†ï¼š${Number(data.score).toFixed(2)}`;
    }

    // çµç®—ç‹€æ…‹æª¢æŸ¥
    if(product && product.settled && Array.isArray(product.winner)){
      const isWinner = product.winner.includes(currentUser);
      if(isWinner){
        info += "\nğŸ‰ æ­å–œï¼ä½ å¾—æ¨™äº†ï¼";
      } else if(product.start_time > 0) {
        info += "\nå¾ˆéºæ†¾ï¼Œæœ¬æ¬¡æœªå¾—æ¨™";
      }

      if (!hasNotified) {
        if(isWinner){
          alert("ğŸ‰ æ­å–œï¼ä½ å·²ç¶“æˆåŠŸå¾—æ¨™ï¼");
        } else if(product.start_time > 0){
          alert("ç«¶æ¨™çµæŸï¼Œå¾ˆéºæ†¾æœ¬æ¬¡æœªå¾—æ¨™ã€‚");
        }
        hasNotified = true; 
      }
    } else {
      hasNotified = false;
    }
    document.getElementById("myinfo").innerText = info;
  } catch(err){}
}

async function sendBid(){
  const inputEl = document.getElementById("inputBid");
  const v = inputEl.value;
  if(!v && v!==0){ alert("è«‹è¼¸å…¥æ•¸å­—ï¼"); return; }
  
  if(product && product.settled){ alert("æœ¬å•†å“å·²çµæŸï¼Œç„¡æ³•å‡ºåƒ¹ï¼"); return; }
  if(product && Number(v) < product.base_price){ alert("ä½æ–¼æœ€ä½åƒ¹æ ¼!"); return; }

  try{
    const res = await fetch(`${backend}/api/bid`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:currentUser, bid_price:Number(v)})
    });
    const data = await res.json();
    if(data.status === "fail"){
        alert(data.message);
    } else {
        document.getElementById("send_output").innerText = "âœ… å‡ºåƒ¹æˆåŠŸï¼š$"+data.bid_price+" (ç©åˆ†:"+Number(data.score).toFixed(1)+")";
        inputEl.value = ""; // æ¸…ç©º
        await loadBidList();
    }
  } catch(err){
    document.getElementById("send_output").innerText = "âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯";
  }
}

function logout(){
    if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")){
        localStorage.removeItem("username");
        localStorage.removeItem("weight");
        window.location.href = "login.html";
    }
}

(async function init(){
  await refreshUserWeight();
  await loadProductInfo();
  setInterval(async ()=>{
    refreshUserWeight();
    loadProductInfo();
    updateCountdown();
    loadBidList();
  },1000);
})();
</script>
</body>
</html>