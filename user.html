<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç«¶åƒ¹ç³»çµ± - Demo</title>
<style>
:root{
  --bg: #f5f7fa;
  --card: #ffffff;
  --primary: #4a8bff;
  --accent: #eef3ff;
  --muted: #667;
  --radius: 12px;
}

* { box-sizing: border-box; }
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 40px 16px;
  color: #222;
}

.page {
  max-width: 1100px;
  margin: 0 auto;
}

#product-info {
  width: 100%;
  margin-bottom: 24px;
  padding: 18px 20px;
  background-color: var(--accent);
  border-radius: var(--radius);
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  color: #222;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

#product-info h2 { margin: 0; font-size: 20px; }
#product-info .meta { text-align: right; color: var(--muted); }

.main {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.container {
  flex: 1 1 420px;
  background: var(--card);
  padding: 22px;
  border-radius: var(--radius);
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

.container h1 {
  margin: 0 0 18px 0;
  font-size: 22px;
  color: #222;
  text-align: left;
}

label { display:block; margin-bottom:8px; color:#444; font-size:14px; }
input[type="number"] {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px solid #ddd;
  margin-bottom: 12px;
}

.btn {
  width: 100%;
  padding: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
}

#send_output {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  background: #fbfdff;
  border: 1px solid #eef4ff;
  color: #222;
  min-height: 36px;
  font-size: 15px;
}

.board {
  width: 360px;
  flex: 0 0 360px;
  background: #f7fbff;
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.04);
}

.board h2 {
  margin: 0 0 12px 0;
  font-size: 18px;
}

#ranking {
  background: #fff;
  border-radius: 10px;
  padding: 8px;
  border: 1px solid #e6eefc;
  max-height: 320px;
  overflow: auto;
}

.rank-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-bottom: 1px dashed #f0f4ff;
}
.rank-row:last-child { border-bottom: none; }

.rank-num { font-weight: 700; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; border-radius: 8px; background: linear-gradient(180deg,#fff,#f2f8ff); color: #0b62a8; }
.rank-user { flex: 1; color: #223; font-weight: 600; }
.rank-price, .rank-score { font-weight: 700; color: #0077cc; }

#myinfo {
  margin-top: 12px;
  background: #eef3ff;
  border-radius: 8px;
  padding: 10px;
  font-size: 14px;
  border: 1px solid #d6e6ff;
  white-space: pre-wrap;
}

.board button {
  width: 100%;
  padding: 10px;
  margin-top: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
}

#logout-btn {
  background: #ff5b5b;
  margin-top: 10px;
}
#logout-btn:hover {
  background: #e03f3f;
}

@media (max-width: 880px) {
  .main { flex-direction: column; }
  .board { width: 100%; flex: 1 1 auto; }
  .container { width: 100%; }
}
</style>
</head>

<body>
<div class="page">
  <div id="product-info">
    <div>
      <h2 id="product-name">â€”</h2>
      <div style="color:#445; margin-top:6px;">ç«¶æ‹å•†å“</div>
    </div>
    <div class="meta">
      <div>å¯å”®ä»½æ•¸: <strong id="product-quantity">3</strong></div>
      <div style="margin-top:6px;">ç›®å‰æœ€é«˜åƒ¹: <strong id="product-highest">â€”</strong></div>
      <div style="margin-top:6px;">å¾—æ¨™æœ€ä½åƒ¹: <strong id="product-min-winner">â€”</strong></div>
      <div style="margin-top:6px;">è¦æ±‚æœ€ä½åƒ¹: <strong id="product-min-required">â€”</strong></div>
      <div style="margin-top:6px;">å‰©é¤˜æ™‚é–“: <strong id="product-countdown">â€”</strong></div>
      <button onclick="loadProductInfo()">æ›´æ–°å•†å“è³‡è¨Š</button>
    </div>
  </div>

  <div class="main">
    <div class="container">
      <h1>å‡ºåƒ¹</h1>
      <label for="inputBid">è¼¸å…¥å‡ºåƒ¹ï¼ˆæ•¸å­—ï¼‰</label>
      <input id="inputBid" type="number" placeholder="è¼¸å…¥æ•¸å­—">
      <button class="btn" onclick="sendBid()">å‚³é€å‡ºåƒ¹</button>
      <div id="send_output">é€å‡ºçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
      <button id="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="board">
      <h2>å¾—æ¨™æ’è¡Œæ¦œ</h2>
      <div id="ranking"></div>

      <h3 style="margin-top:12px;">æˆ‘çš„å‡ºåƒ¹è³‡è¨Š</h3>
      <div id="myinfo">å°šæœªå‡ºåƒ¹</div>

      <button onclick="loadBidList()">åˆ·æ–°æ’è¡Œæ¦œ</button>
    </div>
  </div>
</div>

<script>
const backend = "http://localhost:8000";

// ğŸŒŸ å¾ localStorage å–å¾—ç™»å…¥ä½¿ç”¨è€…
const currentUser = localStorage.getItem("username");
if(!currentUser){
    alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
    window.location.href = "login.html";
}

let product = null;

// HTML escape
function escapeHtml(str) {
  return String(str).replace(/&/g,"&amp;")
                    .replace(/</g,"&lt;")
                    .replace(/>/g,"&gt;")
                    .replace(/"/g,"&quot;")
                    .replace(/'/g,"&#039;");
}

// å–å¾—å•†å“è³‡è¨Š
async function loadProductInfo(){
  try {
    product = await fetch(`${backend}/api/get_product`).then(r => r.json());
    document.getElementById("product-name").innerText = product.name;
    document.getElementById("product-quantity").innerText = product.total_quantity;
    
    let sortedBids = [...product.bids].sort((a,b)=>b.score - a.score);
    let seenUsers = new Set();
    let winners = [];
    for(let bid of sortedBids){
      if(!seenUsers.has(bid.user_id)){
        winners.push(bid.bid_price);
        seenUsers.add(bid.user_id);
      }
      if(winners.length >= product.total_quantity) break;
    }
    document.getElementById("product-min-winner").innerText = winners.length ? Math.min(...winners) : "â€”";

    document.getElementById("product-min-required").innerText = product.base_price ?? "â€”";

    updateCountdown();
    loadBidList(); // åŒæ­¥åˆ·æ–°æ’è¡Œæ¦œ
  } catch(e){
    console.error(e);
  }
}

// å€’æ•¸æ™‚é–“æ›´æ–°
function updateCountdown(){
  if(!product || !product.start_time || !product.period) return;
  const now = Date.now();
  let remainMs = product.start_time + product.period - now;
  if(remainMs < 0) remainMs = 0;
  const minutes = Math.floor(remainMs / 60000);
  const seconds = Math.floor((remainMs % 60000)/1000);
  document.getElementById("product-countdown").innerText = `${minutes}åˆ† ${seconds}ç§’`;
}

// æ’è¡Œæ¦œæ›´æ–°ï¼ˆå¼·åˆ¶åˆ·æ–°å…§å®¹ï¼‰
async function loadBidList(){
  if(!product) await loadProductInfo();
  try {
    const res = await fetch(`${backend}/api/bid_list`);
    const ranking = await res.json();
    const rankDiv = document.getElementById("ranking");
    rankDiv.innerHTML = ""; // å…ˆæ¸…ç©ºå®¹å™¨

    ranking.forEach((item, idx)=>{
      const row = document.createElement("div");
      row.className = "rank-row";
      row.dataset.user = item.user_id;
      const displayScore = Number(item.score).toFixed(2);
      row.innerHTML = `
        <div class="rank-num">${idx+1}</div>
        <div class="rank-user">${escapeHtml(item.user_id)}</div>
        <div class="rank-price">$${item.bid_price}</div>
        <div class="rank-score">${displayScore}</div>
      `;
      rankDiv.appendChild(row);
    });

    // æ›´æ–°æœ€é«˜åƒ¹
    document.getElementById("product-highest").innerText = ranking.length ? ranking[0].bid_price : "â€”";
    await updateMyInfo();
  } catch(err){
    console.error(err);
  }
}

// æˆ‘çš„å‡ºåƒ¹è³‡è¨Š
// æˆ‘çš„å‡ºåƒ¹è³‡è¨Š + å¾—æ¨™æç¤º
async function updateMyInfo(){
  try{
    const res = await fetch(`${backend}/api/get_bid_price?user_id=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    let info = "";
    if(data.message){
      info = data.message;
    } else {
      info = `æˆ‘ (${currentUser}) çš„æœ€é«˜å‡ºåƒ¹ï¼š$${data.highest_bid}\nç«¶æ¨™åˆ†æ•¸ï¼š${data.score}`;
    }

    // é¡¯ç¤ºæˆ‘æ˜¯å¦å¾—æ¨™
    if(product.settled && Array.isArray(product.winner)){
      if(product.winner.includes(currentUser)){
        info += "\næ­å–œï¼ä½ å¾—æ¨™äº†ï¼";
      } else {
        info += "\nå¾ˆéºæ†¾ï¼Œæœ¬æ¬¡æœªå¾—æ¨™";
      }
    }

    document.getElementById("myinfo").innerText = info;
  } catch(err){
    document.getElementById("myinfo").innerText = "ç„¡æ³•å–å¾—æˆ‘çš„å‡ºåƒ¹è³‡è¨Š";
  }
}


// é€å‡ºå‡ºåƒ¹
async function sendBid(){
  const v = document.getElementById("inputBid").value;
  if(!v && v!==0){ alert("è«‹è¼¸å…¥æ•¸å­—ï¼"); return; }
  
  if(product.settled){
    alert("æœ¬å•†å“å·²çµæŸï¼Œç„¡æ³•å‡ºåƒ¹ï¼");
    return;
  }

  if(Number(v) < product.base_price){
    alert("ä½æ–¼æœ€ä½åƒ¹æ ¼!");
    return;
  }

  try{
    const res = await fetch(`${backend}/api/bid`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user_id:currentUser, bid_price:Number(v)})
    });
    const data = await res.json();
    document.getElementById("send_output").innerText = "é€å‡ºæˆåŠŸï¼Œæ–°å€¼ç‚ºï¼š"+data.bid_price+"ï¼Œåˆ†æ•¸ï¼š"+data.score;
    await loadBidList();
  } catch(err){
    console.error(err);
    document.getElementById("send_output").innerText = "é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯";
  }
}

// ç™»å‡º
function logout(){
    localStorage.removeItem("username");
    localStorage.removeItem("weight");
    window.location.href = "login.html";
}

// åˆå§‹åŒ–
(async function init(){
  await loadProductInfo();
  // æ¯ç§’æ›´æ–°å€’æ•¸æ™‚é–“èˆ‡æ’è¡Œæ¦œ
  setInterval(()=>{
    loadProductInfo();
    updateCountdown();
    loadBidList();
  },1000);
})();
</script>
</body>
</html>


