<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†å“¡å¾Œå°</title>

  <style>
    :root {
      --primary: #4267ff;
      --primary-hover: #2f4de0;
      --bg: #f4f6fb;
      --card-bg: #ffffff;
      --text: #333;
      --border: #e0e0e0;
    }

    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 30px;
      color: var(--text);
    }

    h1 { text-align: center; margin-bottom: 30px; color: #2c3e50; }

    .layout {
      display: flex;
      gap: 25px;
      max-width: 1200px;
      margin: auto;
    }

    /* å·¦å´é¢æ¿æ¨£å¼ */
    .left-panel {
      background: var(--card-bg);
      flex: 0 0 350px; /* å›ºå®šå¯¬åº¦ */
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: fit-content;
    }

    /* å³å´é¢æ¿å®¹å™¨ (åŒ…å«ä¸Šä¸‹å…©å€‹å€å¡Š) */
    .right-panel-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .info-card, .ranking-card {
      background: var(--card-bg);
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    h2 { margin-top: 0; color: #444; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; font-size: 1.2rem; }

    /* è¡¨å–®æ¨£å¼ */
    label { font-weight: 600; display: block; margin-top: 15px; font-size: 0.95rem; }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 6px;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input:focus { border-color: var(--primary); outline: none; }
    input.error { border-color: #ff4d4f; background: #fff1f0; }

    button {
      margin-top: 25px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: var(--primary-hover); }

    #responseBox {
      margin-top: 20px;
      padding: 15px;
      background: #eef3ff;
      border-radius: 8px;
      display: none;
      white-space: pre-line;
      font-size: 0.9rem;
    }

    /* å•†å“è³‡è¨Šå€å¡Šæ¨£å¼ */
    .product-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #eee;
    }
    .stat-label { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
    .stat-value { font-size: 1.2rem; font-weight: bold; color: #222; }
    #prod-countdown { color: #d63031; }

    /* æ’è¡Œæ¦œç¾åŒ–æ¨£å¼ */
    .ranking-header {
      display: grid;
      grid-template-columns: 50px 1fr 100px 80px 100px;
      padding: 10px;
      background: #f1f3f5;
      font-weight: bold;
      font-size: 0.9rem;
      color: #555;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .rank-row {
      display: grid;
      grid-template-columns: 50px 1fr 100px 80px 100px;
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      align-items: center;
      font-size: 0.95rem;
      transition: background 0.1s;
    }
    .rank-row:last-child { border-bottom: none; }
    .rank-row:hover { background: #f8f9ff; }

    /* æ’åå¾½ç«  */
    .rank-badge {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 50%;
      background: #eee;
      color: #555;
      font-size: 12px;
      font-weight: bold;
    }
    .rank-row:nth-child(1) .rank-badge { background: #ffd700; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2); } /* é‡‘ */
    .rank-row:nth-child(2) .rank-badge { background: #c0c0c0; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2); } /* éŠ€ */
    .rank-row:nth-child(3) .rank-badge { background: #cd7f32; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2); } /* éŠ… */

    .rank-price { font-weight: bold; color: var(--primary); }
    .rank-score { font-weight: bold; color: #e67e22; }
    .rank-remaining { font-size: 0.85rem; color: #888; }
    .rank-user { font-weight: 500; }

    /* RWD */
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .left-panel { flex: none; width: auto; }
    }
  </style>
</head>

<body>
  <h1>ç®¡ç†å“¡å¾Œå°</h1>

  <div class="layout">
    <div class="left-panel">
      <h2>ğŸ“¦ ä¸Šæ¶å•†å“</h2>

      <label>å•†å“åç¨±</label>
      <input id="item_name" placeholder="è¼¸å…¥å•†å“åç¨±" />

      <label>åº•åƒ¹</label>
      <input id="base_price" type="number" placeholder="è¼¸å…¥å•†å“åº•åƒ¹" />

      <label>åº«å­˜é‡</label>
      <input id="stock" type="number" placeholder="è¼¸å…¥åº«å­˜é‡" />

      <label>ç¶­æŒæ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
      <input id="duration" type="number" placeholder="è¼¸å…¥ç¶­æŒæ™‚é–“" />

      <label>&alpha; (Alpha) æ¬Šé‡ - åƒ¹æ ¼ P</label>
      <input id="score_a" type="number" placeholder="è¼¸å…¥ &alpha; åƒæ•¸" />

      <label>&beta; (Beta) æ¬Šé‡ - æ™‚é–“ T</label>
      <input id="score_b" type="number" placeholder="è¼¸å…¥ &beta; åƒæ•¸" />

      <label>&gamma; (Gamma) æ¬Šé‡ - æœƒå“¡ W</label>
      <input id="score_c" type="number" placeholder="è¼¸å…¥ &gamma; åƒæ•¸" />

      <button onclick="submitItem()">ä¸Šæ¶å•†å“ & è¨­å®šåƒæ•¸</button>

      <div id="responseBox"></div>
    </div>

    <div class="right-panel-container">
      
      <div class="info-card">
        <h2>â„¹ï¸ ç›®å‰å•†å“è³‡è¨Š</h2>
        <h3 id="prod-name" style="text-align:center; font-size:1.5rem; margin:10px 0;">(æš«ç„¡å•†å“)</h3>
        
        <div class="product-stats">
          <div class="stat-box">
            <div class="stat-label">å¯å”®ä»½æ•¸</div>
            <div class="stat-value" id="prod-quantity">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">ç›®å‰æœ€é«˜åƒ¹</div>
            <div class="stat-value" id="prod-highest">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">å‰©é¤˜æ™‚é–“</div>
            <div class="stat-value" id="prod-countdown">--:--</div>
          </div>
           <div class="stat-box">
            <div class="stat-label">ç‹€æ…‹</div>
            <div class="stat-value" id="prod-status">ç­‰å¾…ä¸­</div>
          </div>
        </div>
      </div>

      <div class="ranking-card">
        <h2>ğŸ† å³æ™‚æˆ°æ³æ’è¡Œæ¦œ</h2>
        
        <div class="ranking-header">
          <div>æ’å</div>
          <div>ç”¨æˆ¶</div>
          <div>å‡ºåƒ¹</div>
          <div>ç©åˆ†</div>
          <div>å‡ºåƒ¹æ™‚é–“</div>
        </div>

        <div id="prod-ranking">
          </div>
      </div>

    </div>
  </div>

  <script>
    const backend = "http://bid-alb-1309857608.us-east-1.elb.amazonaws.com";
    let product = null;

    function validateInputs(fields) {
      let ok = true;
      fields.forEach(f => {
        const el = document.getElementById(f);
        if (!el.value) {
          el.classList.add('error');
          ok = false;
        } else {
          el.classList.remove('error');
        }
      });
      return ok;
    }

    async function submitItem() {
      const fields = ['item_name','base_price','stock','duration','score_a','score_b','score_c'];
      if(!validateInputs(fields)){
        const box = document.getElementById('responseBox');
        box.style.display='block'; box.style.color='red';
        box.textContent="âŒ è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼";
        return;
      }

      const payload = {
        name: document.getElementById('item_name').value,
        base_price: Number(document.getElementById('base_price').value),
        total_quantity: Number(document.getElementById('stock').value),
        duration_minutes: Number(document.getElementById('duration').value)
      };

      const scores = {
        A: Number(document.getElementById('score_a').value),
        B: Number(document.getElementById('score_b').value),
        C: Number(document.getElementById('score_c').value)
      };

      try {
        const res1 = await fetch(`${backend}/admin/set_product`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const prodResult = await res1.json();
        product = prodResult.product;

        await fetch(`${backend}/admin/set_score`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(scores)
        });

        const box = document.getElementById('responseBox');
        box.style.display='block'; box.style.color='green';
        // ä½¿ç”¨å¸Œè‡˜å­—æ¯é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        box.textContent = `âœ… ä¸Šæ¶æˆåŠŸï¼\nå•†å“ï¼š${product.name}\nåƒæ•¸ï¼š\u03B1=${scores.A}, \u03B2=${scores.B}, \u03B3=${scores.C}`;

        fields.forEach(f=>document.getElementById(f).value="");

      } catch(e) {
        console.error(e);
        const box = document.getElementById('responseBox');
        box.style.display='block'; box.style.color='red';
        box.textContent="âŒ ä¸Šæ¶å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·š";
      }
    }

    async function loadProductInfo() {
      try {
        // å–å¾—å•†å“
        const res = await fetch(`${backend}/api/get_product`);
        product = await res.json();
        
        if(product.name) {
             document.getElementById("prod-name").textContent = product.name;
             document.getElementById("prod-quantity").textContent = product.total_quantity;
             document.getElementById("prod-status").textContent = product.settled ? "å·²çµç®—" : "ç«¶æ¨™ä¸­";
             document.getElementById("prod-status").style.color = product.settled ? "red" : "green";
        } else {
             document.getElementById("prod-name").textContent = "(æš«ç„¡å•†å“)";
        }

        // å–å¾—å‡ºåƒ¹æ¸…å–®
        const res2 = await fetch(`${backend}/api/bid_list`);
        const bids = await res2.json();

        // æœ€é«˜åƒ¹
        const highest = bids.length ? Math.max(...bids.map(b=>b.bid_price)) : 0;
        document.getElementById("prod-highest").textContent = highest > 0 ? `$${highest}` : "-";

        // æ’è¡Œæ¦œæ¸²æŸ“
        const rankingDiv = document.getElementById("prod-ranking");
        rankingDiv.innerHTML = "";
        
        if(bids.length === 0) {
             rankingDiv.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">å°šç„¡å‡ºåƒ¹ç´€éŒ„</div>`;
        } else {
             bids.forEach((b, idx) => {
               const row = document.createElement("div");
               row.className = "rank-row";
               row.dataset.bidTime = b.timestamp; // ç”¨æ–¼å€’æ•¸è¨ˆæ™‚è¨ˆç®—
               
               // è¨ˆç®—å‡ºåƒ¹æ™‚é–“å·®é¡¯ç¤º (åƒ…ä½œåƒè€ƒï¼Œå¯¦éš›å‹•æ…‹å€’æ•¸ç”± updateCountdown è™•ç†)
               row.innerHTML = `
                 <div><span class="rank-badge">${idx+1}</span></div>
                 <div class="rank-user">${b.user_id}</div>
                 <div class="rank-price">$${b.bid_price}</div>
                 <div class="rank-score">${b.score.toFixed(2)}</div>
                 <div class="rank-remaining">--:--</div>
               `;
               rankingDiv.appendChild(row);
             });
        }

        updateCountdown();
      } catch(e){
        console.error(e);
      }
    }

    function updateCountdown() {
      if(!product || !product.start_time || !product.period) return;

      const now = Date.now();
      let remaining = product.start_time + product.period - now;
      if(remaining < 0) remaining = 0;

      const min = Math.floor(remaining / 60000);
      const sec = Math.floor((remaining % 60000) / 1000);
      document.getElementById("prod-countdown").textContent = `${min}åˆ†${sec}ç§’`;

      // æ›´æ–°æ’è¡Œæ¦œä¸­çš„æ¯ä¸€åˆ—çš„å‡ºåƒ¹ç›¸å°æ™‚é–“ (å‡è¨­åŸæœ¬é‚è¼¯æ˜¯æƒ³é¡¯ç¤ºè©²æ¬¡å‡ºåƒ¹ç•¶ä¸‹çš„å‰©é¤˜æ™‚é–“ï¼Œæˆ–è©²å‡ºåƒ¹è·é›¢çµæŸçš„æ™‚é–“)
      // é€™è£¡ç¶­æŒæ‚¨åŸæœ¬çš„é‚è¼¯ï¼šé¡¯ç¤º (ç¸½æ™‚é•· - (å‡ºåƒ¹æ™‚é–“ - é–‹å§‹æ™‚é–“)) = å‡ºåƒ¹ç•¶ä¸‹çš„å‰©é¤˜æ™‚é–“
      document.querySelectorAll(".rank-row").forEach(row => {
        const bidTime = Number(row.dataset.bidTime);
        if(bidTime) {
            let rem = Math.max(product.period - (bidTime - product.start_time), 0);
            const m = Math.floor(rem / 60000);
            const s = Math.floor((rem % 60000) / 1000);
            row.querySelector(".rank-remaining").textContent = `${m}åˆ†${s}ç§’`;
        }
      });
    }

    // æ¯ç§’è‡ªå‹•åˆ·æ–°
    setInterval(loadProductInfo, 1000);

    // åˆå§‹åŒ–
    loadProductInfo();
  </script>
</body>
</html>
